<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pi Metrics</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; }
    html, body {
      margin: 0;
      padding: 0;
      /*height: 100%;*/
      /*overflow: hidden;  prevents both vertical and horizontal scrolling */
}

    .chart-grid {
      display: grid;
      grid-template-columns: 1fr ;
      grid-template-rows: 1fr 1fr;
      height: 100vh;
      width: 100vw;
      gap: 1rem;
      padding: 1rem;
      box-sizing: border-box;
}

      canvas {
        width: 100%;
        height: 100%;
        display: block;
}
  </style>
</head>
<body>
<div class="chart-grid">
  <canvas id="freqCanvas"></canvas>
  <canvas id="tempCanvas"></canvas>
</div>

<script>
    function resizeCanvas(canvas) {
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;
}
    async function updateFreqChart() {
      const resp = await fetch("/api/pifreq");
      const data = await resp.json();

      const points = data.timestamps.map((ts, i) => ({
        x: new Date(ts),
        y: data.freqs[i]
      }));
      const canvas = document.getElementById("freqCanvas");
      resizeCanvas(canvas);
      const ctx = canvas.getContext("2d");

      const dpr = window.devicePixelRatio || 1;
      canvas.width = window.innerWidth * dpr;
      canvas.height = window.innerHeight * dpr;
      canvas.style.width = window.innerWidth + 'px';
      canvas.style.height = window.innerHeight + 'px';
      ctx.scale(dpr, dpr); // Adjust drawing scale


      if (window.metricsChart) window.metricsChart.destroy();

    window.metricsChart = new Chart(ctx, {
            type: "line",
            data: { datasets: [
                {
                  label: "Freq (MHz)",
                  data: points,
                  borderColor: "green",
                  fill: false,
                  yAxisID: "yFreq"
                }
              ]
            },
            options: {
              scales: {
                x: {
                  type: 'time',
                  time: {
                    unit: 'minute',
                    displayFormats: { hour: 'MMM d, HH:mm' }
                  },
                  title: { display: true, text: "Time" }
                },
                yFreq: {
                  type: 'linear',
                  position: 'left',
                  min: 500,
                  max: 1600,
                  title: { display: true, text: "Frequency (MHz)" }
                }/*,
                yLoad: {
                  type: 'linear',
                  position: 'right',
                  min: 0,
                  max: 100,
                  grid: { drawOnChartArea: false },
                  title: { display: true, text: "CPU Load (%)" }
                },
                yFreq: {
                  type: 'linear',
                  position: 'right',
                  min: 100,
                  max: 2000,
                  grid: { drawOnChartArea: false },
                  title: { display: true, text: "CPU Freq (MHz)" }
                },
                yRam: {
                  type: 'linear',
                  position: 'left',
                  min: 0,
                  max: 100,
                  grid: { drawOnChartArea: false },
                  title: { display: true, text: "RAM Usage (%)" }
                }
              */},
              plugins: {
                decimation: {enabled: true, algorithm: 'lttb', samples: 1000 },
                title: {display: true, text: 'CPU Frequency (MHz)'},
                tooltip: { mode: "index", intersect: false }
              }
            }
          });
    }

    // Initial load
    updateFreqChart();
    // Refresh every minute
    setInterval(updateFreqChart, 60_000);
  </script> 

  <script>
    async function updateTempChart() {
      const resp = await fetch("/api/pitemp");
      const data = await resp.json();

      // parse timestamps
      const points = data.timestamps.map((ts, i) => ({
        x: new Date(ts),
        y: data.temps[i]
      }));

      const canvas = document.getElementById("tempCanvas");
      resizeCanvas(canvas);
      const ctx = canvas.getContext("2d");
      
      const dpr = window.devicePixelRatio || 1;
      canvas.width = window.innerWidth * dpr;
      canvas.height = window.innerHeight * dpr;
      canvas.style.width = window.innerWidth + 'px';
      canvas.style.height = window.innerHeight + 'px';
      ctx.scale(dpr, dpr); // Adjust drawing scale


      // destroy old chart if exists
      if (window.tempChart) window.tempChart.destroy();

    window.tempChart = new Chart(ctx, {
        type: "line",
        data: { datasets: [{
          label: "Temp (°C)",
          data: points,
          borderColor: "red",
          fill: false,
          yAxisID: "yTemp"
        }]},
        options: {
          scales: {
            x: {
              type: "time",
              time: {
                unit: "minute",
                displayFormats: { hour: "MMM d, HH:mm" }
              },
              title: { display: true, text: "Time" }
            },
            yTemp: {
              type: "linear",
              position: "left",
              min: 25,
              max: 85,
              title: { display: true, text: "Temperature (°C)" }
            }
          },
          plugins: {
            decimation: { enabled: true, algorithm: "lttb", samples: 1000 },
            title:{ display: true, text: 'CPU Temperature (°C)'},
            tooltip: { mode: "index", intersect: false }
          }
        }
      });
    }

    // initial draw and periodic refresh
    updateTempChart();
    setInterval(updateTempChart, 60_000);

    //resize 

    window.addEventListener('resize', () => {
  ['freqCanvas', 'tempCanvas'].forEach(id => {
    const canvas = document.getElementById(id);
    resizeCanvas(canvas);
  });
});
  </script>  
</body>
</html>